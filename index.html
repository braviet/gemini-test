<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gemini Prompt UI — Web</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50">
  <div id="root" class="p-4 md:p-8"></div>

  <script type="text/babel">
    const { useState, useMemo } = React;

    const SCENES = [
      "Hanoi street at dusk (Hoan Kiem area, mixed low-rise shophouses)",
      "Hanoi rainy evening (wet asphalt reflections)",
      "Hanoi with festival lanterns and shop signs"
    ];
    const ANGLES = [
      "Wide Street View",
      "Eye-Level Human Perspective",
      "Upward Hero Shot",
      "Close-up Detail Shot"
    ];
    const WEATHERS = ["Clear twilight", "Cloudy dusk", "Rainy evening"];
    const LIGHTING = [
      "Vertical façade lights (warm linear grazers on decorative columns)",
      "Warm linear lights + soft interior glow",
      "High-contrast dramatic lighting"
    ];
    const FOCAL = ["24mm (wide)", "35mm (street)", "50mm (standard)"];
    const RESOLUTIONS = ["2048 × 2048", "3072 × 2048", "4096 × 2304"];
    const REFLECTION = ["Subtle low-e reflections", "Balanced low-e reflections", "Strong mirror-like reflections"];

    function Section({ title, children }){
      return (
        <div className="rounded-2xl border bg-white shadow-sm p-4 md:p-5">
          <h2 className="text-lg font-semibold mb-3">{title}</h2>
          {children}
        </div>
      );
    }

    function App(){
      const [sketchFile, setSketchFile] = useState(null);
      const [sketchUrl, setSketchUrl] = useState("");
      const [refFile, setRefFile] = useState(null);
      const [refUrl, setRefUrl] = useState("");

      const [scene, setScene] = useState(SCENES[0]);
      const [angle, setAngle] = useState(ANGLES[0]);
      const [weather, setWeather] = useState(WEATHERS[0]);
      const [lighting, setLighting] = useState(LIGHTING[0]);
      const [focal, setFocal] = useState(FOCAL[1]);
      const [resolution, setResolution] = useState(RESOLUTIONS[1]);
      const [reflection, setReflection] = useState(REFLECTION[1]);
      const [strength, setStrength] = useState(0.65);
      const [noise, setNoise] = useState(0.15);
      const [notes, setNotes] = useState("");

      const [loading, setLoading] = useState("");
      const [error, setError] = useState("");
      const [outUrl, setOutUrl] = useState("");

      function fileToDataUrl(file){
        return new Promise((resolve)=>{
          if(!file) return resolve("");
          const r = new FileReader();
          r.onload = ()=> resolve(String(r.result));
          r.readAsDataURL(file);
        });
      }

      const prompt = useMemo(()=>{
        const extra = notes.trim()? "\nUser notes: " + notes.trim() : "";
        return [
          "Transform this architectural sketch into a professional, magazine-style architectural photograph.",
          "Project: a 12-story modern office building in Hanoi with a low-e glass façade and marble podium cladding.",
          `Scene: ${scene}. Angle: ${angle}. Weather: ${weather}.`,
          `Camera: ${focal}. Resolution target: ${resolution}.`,
          `Lighting: ${lighting}. Glass: ${reflection}.`,
          "Atmosphere: cinematic Hanoi street context with motorbikes, shop signs, pedestrians.",
          `Image-to-image settings (if supported): strength ${strength.toFixed(2)}, denoise ${noise.toFixed(2)}.`,
          (refFile? "Use reference image colors & mood from uploaded reference." : ""),
          extra
        ].filter(Boolean).join("\n");
      }, [scene, angle, weather, focal, resolution, lighting, reflection, strength, noise, notes, refFile]);

      async function onGenerate(){
        try{
          setError(""); setLoading("Generating…"); setOutUrl("");
          const sketch64 = await fileToDataUrl(sketchFile);
          const ref64 = await fileToDataUrl(refFile);
          const res = await fetch("/api/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              prompt,
              useBundle: false,
              sketchBase64: sketch64,
              referenceBase64: ref64
            })
          });
          if(!res.ok){
            const t = await res.text();
            throw new Error(t);
          }
          const data = await res.json();
          setOutUrl(data.imageUrl || "");
        }catch(e){
          setError(e.message || String(e));
        }finally{
          setLoading("");
        }
      }

      return (
        <div className="mx-auto max-w-5xl space-y-5">
          <header>
            <h1 className="text-2xl md:text-3xl font-bold">Gemini Prompt UI — Web Only</h1>
            <p className="text-gray-600">Host this on Vercel. No install on your machine.</p>
          </header>

          <div className="grid md:grid-cols-3 gap-4">
            <Section title="Sketch / Reference">
              <label className="block text-sm font-medium mb-1">Upload Sketch</label>
              <input type="file" accept="image/*" onChange={(e)=>{setSketchFile(e.target.files?.[0]||null); setSketchUrl(e.target.files?.[0]? URL.createObjectURL(e.target.files[0]) : "");}} />
              {sketchUrl && <img src={sketchUrl} className="mt-2 max-h-40 rounded border" />}
              <label className="block text-sm font-medium mt-4 mb-1">Tone/Mood Reference</label>
              <input type="file" accept="image/*" onChange={(e)=>{setRefFile(e.target.files?.[0]||null); setRefUrl(e.target.files?.[0]? URL.createObjectURL(e.target.files[0]) : "");}} />
              {refUrl && <img src={refUrl} className="mt-2 max-h-40 rounded border" />}
            </Section>

            <Section title="Scene & Camera">
              <label className="block text-sm font-medium">Scene</label>
              <select className="w-full border rounded p-2 mb-2" value={scene} onChange={e=>setScene(e.target.value)}>{SCENES.map(s=> <option key={s}>{s}</option>)}</select>

              <label className="block text-sm font-medium">Angle</label>
              <select className="w-full border rounded p-2 mb-2" value={angle} onChange={e=>setAngle(e.target.value)}>{ANGLES.map(s=> <option key={s}>{s}</option>)}</select>

              <label className="block text-sm font-medium">Weather</label>
              <select className="w-full border rounded p-2 mb-2" value={weather} onChange={e=>setWeather(e.target.value)}>{WEATHERS.map(s=> <option key={s}>{s}</option>)}</select>

              <div className="grid grid-cols-2 gap-2">
                <div>
                  <label className="block text-sm font-medium">Focal</label>
                  <select className="w-full border rounded p-2" value={focal} onChange={e=>setFocal(e.target.value)}>{FOCAL.map(s=> <option key={s}>{s}</option>)}</select>
                </div>
                <div>
                  <label className="block text-sm font-medium">Resolution</label>
                  <select className="w-full border rounded p-2" value={resolution} onChange={e=>setResolution(e.target.value)}>{RESOLUTIONS.map(s=> <option key={s}>{s}</option>)}</select>
                </div>
              </div>
            </Section>

            <Section title="Lighting & Options">
              <label className="block text-sm font-medium">Lighting</label>
              <select className="w-full border rounded p-2 mb-2" value={lighting} onChange={e=>setLighting(e.target.value)}>{LIGHTING.map(s=> <option key={s}>{s}</option>)}</select>

              <label className="block text-sm font-medium">Low-E Glass Reflection</label>
              <select className="w-full border rounded p-2 mb-2" value={reflection} onChange={e=>setReflection(e.target.value)}>{REFLECTION.map(s=> <option key={s}>{s}</option>)}</select>

              <div className="grid grid-cols-2 gap-2">
                <div>
                  <label className="block text-sm font-medium">Strength</label>
                  <input type="range" min="0" max="1" step="0.01" value={strength} onChange={e=>setStrength(parseFloat(e.target.value))} className="w-full" />
                  <div className="text-xs text-gray-600">{strength.toFixed(2)}</div>
                </div>
                <div>
                  <label className="block text-sm font-medium">Denoise</label>
                  <input type="range" min="0" max="1" step="0.01" value={noise} onChange={e=>setNoise(parseFloat(e.target.value))} className="w-full" />
                  <div className="text-xs text-gray-600">{noise.toFixed(2)}</div>
                </div>
              </div>
            </Section>
          </div>

          <Section title="Prompt Preview">
            <textarea className="w-full h-48 p-2 border rounded font-mono text-sm" readOnly value={prompt}></textarea>
            <div className="mt-3 flex gap-2">
              <button className="px-4 py-2 rounded bg-black text-white" onClick={()=>navigator.clipboard.writeText(prompt)}>Copy Prompt</button>
              <button className="px-4 py-2 rounded border" onClick={onGenerate}>Generate via Gemini (Web)</button>
            </div>
          </Section>

          <Section title="Result">
            {loading && <p className="text-blue-700 text-sm">{loading}</p>}
            {error && <p className="text-red-600 text-sm">{error}</p>}
            {outUrl && <img src={outUrl} className="max-h-[70vh] rounded border" />}
          </Section>

          <footer className="text-xs text-gray-500">Deploy on Vercel. Set GEMINI_API_KEY in Project → Settings → Environment Variables.</footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
